<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PaperMinder OTA Debug Console</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ddd;
        }

        .tab {
            padding: 10px 20px;
            background: #e0e0e0;
            border: none;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            font-size: 14px;
            font-weight: 500;
        }

        .tab:hover {
            background: #d0d0d0;
        }

        .tab.active {
            background: #4CAF50;
            color: white;
        }

        .tab-content {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 0 0 5px 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        button {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        button:hover {
            background: #45a049;
        }

        button.secondary {
            background: #2196F3;
        }

        button.secondary:hover {
            background: #0b7dda;
        }

        button.danger {
            background: #f44336;
        }

        button.danger:hover {
            background: #da190b;
        }

        .card {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .card h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #f5f5f5;
            font-weight: 600;
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-success { background: #d4edda; color: #155724; }
        .badge-warning { background: #fff3cd; color: #856404; }
        .badge-danger { background: #f8d7da; color: #721c24; }
        .badge-info { background: #d1ecf1; color: #0c5460; }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-online { background: #4CAF50; }
        .status-offline { background: #f44336; }

        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }

        .alert {
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            font-size: 14px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .hidden {
            display: none;
        }

        #errorLog {
            background: #1e1e1e;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .error-entry {
            margin-bottom: 10px;
            padding: 8px;
            border-left: 3px solid #f44336;
            background: rgba(244, 67, 54, 0.1);
        }

        .error-entry.error {
            border-left-color: #f44336;
        }

        .error-entry.warning {
            border-left-color: #ff9800;
        }

        .error-timestamp {
            color: #888;
            font-size: 11px;
            margin-bottom: 4px;
        }

        .error-status {
            font-weight: bold;
            color: #ff6b6b;
        }

        .error-url {
            color: #61dafb;
            word-break: break-all;
            margin: 4px 0;
        }

        .error-body {
            color: #e2e2e2;
            white-space: pre-wrap;
            font-size: 11px;
        }

        .flex {
            display: flex;
            gap: 10px;
        }

        .flex-grow {
            flex-grow: 1;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            padding: 10px 20px;
            background: #2196F3;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            display: inline-block;
        }

        .file-name {
            margin-left: 10px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üñ®Ô∏è PaperMinder OTA Debug Console</h1>
        <p class="subtitle">Test and debug firmware update functionality</p>

        <div class="tabs">
            <button class="tab active" onclick="showTab('upload')">Upload Firmware</button>
            <button class="tab" onclick="showTab('rollouts')">Rollouts</button>
            <button class="tab" onclick="showTab('printers')">Printers</button>
            <button class="tab" onclick="showTab('websocket')">WebSocket Test</button>
            <button class="tab" onclick="showTab('logs')">Error Logs <span id="errorCount">(0)</span></button>
        </div>

        <div id="alert-container"></div>

        <!-- Upload Firmware Tab -->
        <div id="upload" class="tab-content active">
            <div class="card">
                <h3>Upload New Firmware</h3>
                <form id="uploadForm">
                    <div class="grid">
                        <div class="form-group">
                            <label>Firmware File (.bin)</label>
                            <div class="file-input-wrapper">
                                <label for="firmwareFile" class="file-input-label">Choose File</label>
                                <input type="file" id="firmwareFile" accept=".bin">
                                <span id="fileName" class="file-name">No file chosen</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Version (e.g., 1.0.0)</label>
                            <input type="text" id="version" placeholder="1.0.0" required>
                        </div>
                        <div class="form-group">
                            <label>Channel</label>
                            <select id="channel">
                                <option value="stable" selected>Stable</option>
                                <option value="beta">Beta</option>
                                <option value="canary">Canary</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Mandatory Update</label>
                            <select id="mandatory">
                                <option value="false" selected>No</option>
                                <option value="true">Yes</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Release Notes</label>
                        <textarea id="releaseNotes" placeholder="Bug fixes and improvements..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Changelog</label>
                        <textarea id="changelog" placeholder="- Fixed issue X&#10;- Added feature Y"></textarea>
                    </div>
                    <button type="submit">Upload Firmware</button>
                </form>
            </div>

            <div class="card">
                <h3>Firmware Versions</h3>
                <button class="secondary" onclick="loadFirmwareList()" style="margin-bottom: 10px;">Refresh List</button>
                <div id="firmwareList"></div>
            </div>
        </div>

        <!-- Rollouts Tab -->
        <div id="rollouts" class="tab-content">
            <div class="card">
                <h3>Create New Rollout</h3>
                <form id="rolloutForm">
                    <div class="grid">
                        <div class="form-group">
                            <label>Firmware Version</label>
                            <select id="rolloutFirmware" required>
                                <option value="">Select firmware...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Rollout Type</label>
                            <select id="rolloutType" onchange="toggleRolloutFields()">
                                <option value="immediate" selected>Immediate</option>
                                <option value="gradual">Gradual</option>
                                <option value="scheduled">Scheduled</option>
                            </select>
                        </div>
                        <div class="form-group hidden" id="rolloutPercentageGroup">
                            <label>Rollout Percentage (0-100)</label>
                            <input type="number" id="rolloutPercentage" value="10" min="1" max="100">
                        </div>
                        <div class="form-group hidden" id="scheduledForGroup">
                            <label>Scheduled For</label>
                            <input type="datetime-local" id="scheduledFor">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Target Criteria</label>
                        <select id="targetType" onchange="toggleTargetFields()">
                            <option value="all" selected>All Printers</option>
                            <option value="channel">By Channel</option>
                            <option value="user">By User ID</option>
                            <option value="printer">By Printer ID</option>
                        </select>
                    </div>
                    <div class="form-group hidden" id="targetChannelGroup">
                        <label>Target Channels</label>
                        <select id="targetChannels" multiple>
                            <option value="stable" selected>Stable</option>
                            <option value="beta">Beta</option>
                            <option value="canary">Canary</option>
                        </select>
                    </div>
                    <div class="form-group hidden" id="targetUserGroup">
                        <label>User UUID (comma separated)</label>
                        <input type="text" id="targetUserIds" placeholder="uuid-1, uuid-2">
                    </div>
                    <div class="form-group hidden" id="targetPrinterGroup">
                        <label>Printer UUID (comma separated)</label>
                        <input type="text" id="targetPrinterIds" placeholder="uuid-1, uuid-2">
                    </div>
                    <button type="submit">Create Rollout</button>
                </form>
            </div>

            <div class="card">
                <h3>Active Rollouts</h3>
                <button class="secondary" onclick="loadRollouts()" style="margin-bottom: 10px;">Refresh Rollouts</button>
                <div id="rolloutList"></div>
            </div>
        </div>

        <!-- Printers Tab -->
        <div id="printers" class="tab-content">
            <div class="card">
                <h3>Filter Printers</h3>
                <div class="grid">
                    <div class="form-group">
                        <label>Status</label>
                        <select id="printerStatus" onchange="loadPrinters()">
                            <option value="">All</option>
                            <option value="true">Online Only</option>
                            <option value="false">Offline Only</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Channel</label>
                        <select id="printerChannel" onchange="loadPrinters()">
                            <option value="">All</option>
                            <option value="stable">Stable</option>
                            <option value="beta">Beta</option>
                            <option value="canary">Canary</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Firmware Version</label>
                        <input type="text" id="printerFirmwareVersion" placeholder="e.g., 1.0.0" onchange="loadPrinters()">
                    </div>
                </div>
                <button class="secondary" onclick="loadPrinters()">Apply Filters</button>
            </div>

            <div class="card">
                <h3>Printer List</h3>
                <div id="printerList"></div>
            </div>
        </div>

        <!-- Error Logs Tab -->
        <div id="logs" class="tab-content">
            <div class="card">
                <h3>Error Logs</h3>
                <div class="flex" style="margin-bottom: 15px;">
                    <button class="danger" onclick="clearErrorLog()">Clear Logs</button>
                    <button class="secondary" onclick="exportErrorLog()">Export Logs</button>
                </div>
                <div id="errorLog">No errors logged yet...</div>
            </div>
        </div>

        <!-- WebSocket Test Tab -->
        <div id="websocket" class="tab-content">
            <div class="card">
                <h3>WebSocket Connection Test</h3>
                <div class="grid">
                    <div class="form-group">
                        <label>WebSocket URL</label>
                        <input type="text" id="wsUrl" value="ws://localhost:8000/ws/test-user">
                    </div>
                    <div class="form-group">
                        <label>Actions</label>
                        <div class="flex">
                            <button onclick="connectWebSocket()">Connect</button>
                            <button class="danger" onclick="disconnectWebSocket()">Disconnect</button>
                        </div>
                    </div>
                </div>
                <div id="wsStatus" class="alert" style="display: none;"></div>
            </div>

            <div class="card">
                <h3>Send Printer Subscription Message</h3>
                <form id="subscriptionForm">
                    <div class="grid">
                        <div class="form-group">
                            <label>Printer Name</label>
                            <input type="text" id="printerName" value="Test Printer" required>
                        </div>
                        <div class="form-group">
                            <label>API Key (Printer UUID)</label>
                            <input type="text" id="apiKey" value="test-printer-uuid" required>
                        </div>
                        <div class="form-group">
                            <label>Firmware Version</label>
                            <input type="text" id="currentFirmwareVersion" value="1.0.0" required>
                        </div>
                        <div class="form-group">
                            <label>Auto Update</label>
                            <select id="autoUpdate">
                                <option value="true" selected>Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Update Channel</label>
                            <select id="updateChannel">
                                <option value="stable" selected>Stable</option>
                                <option value="beta">Beta</option>
                                <option value="canary">Canary</option>
                            </select>
                        </div>
                    </div>
                    <button type="submit">Send Subscription</button>
                </form>
            </div>

            <div class="card">
                <h3>Send Firmware Progress Message</h3>
                <form id="progressForm">
                    <div class="grid">
                        <div class="form-group">
                            <label>Percent (0-100)</label>
                            <input type="number" id="progressPercent" value="50" min="0" max="100">
                        </div>
                        <div class="form-group">
                            <label>Status Message</label>
                            <input type="text" id="progressStatus" value="Downloading firmware...">
                        </div>
                    </div>
                    <button type="submit" class="secondary">Send Progress</button>
                </form>
            </div>

            <div class="card">
                <h3>Send Firmware Complete Message</h3>
                <form id="completeForm">
                    <div class="form-group">
                        <label>Installed Version</label>
                        <input type="text" id="completedVersion" value="1.1.0" required>
                    </div>
                    <button type="submit" class="secondary">Send Complete</button>
                </form>
            </div>

            <div class="card">
                <h3>WebSocket Messages Log</h3>
                <button class="secondary" onclick="clearMessageLog()" style="margin-bottom: 10px;">Clear Log</button>
                <pre id="messageLog">No messages yet...</pre>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'http://localhost:8000';
        let authToken = localStorage.getItem('authToken') || null;
        let ws = null;
        let errorLogs = [];

        // Error logging system
        function logError(url, status, errorBody, requestInfo = {}) {
            const timestamp = new Date().toISOString();
            const errorEntry = {
                id: Date.now(),
                timestamp,
                url,
                status,
                body: errorBody,
                request: requestInfo
            };
            errorLogs.unshift(errorEntry);
            updateErrorLogDisplay();
            updateErrorCount();
        }

        function updateErrorLogDisplay() {
            const container = document.getElementById('errorLog');
            if (errorLogs.length === 0) {
                container.innerHTML = '<div style="color: #888;">No errors logged yet...</div>';
                return;
            }

            container.innerHTML = errorLogs.map(error => `
                <div class="error-entry error">
                    <div class="error-timestamp">${new Date(error.timestamp).toLocaleString()}</div>
                    <div class="error-status">${error.status} - ${error.url}</div>
                    ${error.request.method ? `<div style="color: #666; font-size: 11px;">Method: ${error.request.method}</div>` : ''}
                    ${error.request.body ? `<div class="error-url">Request: ${error.request.body}</div>` : ''}
                    ${error.body ? `<div class="error-body">Response: ${JSON.stringify(error.body, null, 2)}</div>` : ''}
                </div>
            `).join('');
        }

        function updateErrorCount() {
            document.getElementById('errorCount').textContent = `(${errorLogs.length})`;
        }

        function clearErrorLog() {
            errorLogs = [];
            updateErrorLogDisplay();
            updateErrorCount();
        }

        function exportErrorLog() {
            const dataStr = JSON.stringify(errorLogs, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `error-log-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // Override fetch to intercept errors
        const originalFetch = window.fetch;
        window.fetch = async function(...args) {
            const url = args[0];
            const options = args[1] || {};

            try {
                const response = await originalFetch(...args);

                if (!response.ok) {
                    let errorBody = null;
                    try {
                        errorBody = await response.clone().json();
                    } catch (e) {
                        try {
                            errorBody = await response.clone().text();
                        } catch (e2) {
                            errorBody = 'Unable to parse response body';
                        }
                    }

                    logError(
                        url.toString(),
                        `${response.status} ${response.statusText}`,
                        errorBody,
                        {
                            method: options.method || 'GET',
                            body: options.body ? options.body.substring(0, 200) + (options.body.length > 200 ? '...' : '') : null
                        }
                    );
                }

                return response;
            } catch (error) {
                logError(
                    url.toString(),
                    'Network Error',
                    { message: error.message },
                    {
                        method: options.method || 'GET',
                        body: options.body ? options.body.substring(0, 200) + (options.body.length > 200 ? '...' : '') : null
                    }
                );
                throw error;
            }
        };

        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            // Load data when switching tabs
            if (tabName === 'upload') loadFirmwareList();
            if (tabName === 'rollouts') {
                loadRollouts();
                loadFirmwareForRollout();
            }
            if (tabName === 'printers') loadPrinters();
            if (tabName === 'logs') updateErrorLogDisplay();
        }

        // Alert handling
        function showAlert(message, type = 'success') {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        // File input handling
        document.getElementById('firmwareFile').addEventListener('change', function(e) {
            const fileName = e.target.files[0]?.name || 'No file chosen';
            document.getElementById('fileName').textContent = fileName;
        });

        // Firmware upload
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = document.getElementById('firmwareFile').files[0];
            if (!file) {
                showAlert('Please select a firmware file', 'error');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);
            formData.append('version', document.getElementById('version').value);
            formData.append('channel', document.getElementById('channel').value);
            formData.append('release_notes', document.getElementById('releaseNotes').value);
            formData.append('changelog', document.getElementById('changelog').value);
            formData.append('mandatory', document.getElementById('mandatory').value === 'true');

            try {
                const response = await fetch(`${API_BASE}/api/firmware/upload`, {
                    method: 'POST',
                    headers: authToken ? { 'Authorization': `Bearer ${authToken}` } : {},
                    body: formData
                });

                if (!response.ok) throw new Error('Upload failed');

                showAlert('Firmware uploaded successfully!');
                document.getElementById('uploadForm').reset();
                document.getElementById('fileName').textContent = 'No file chosen';
                loadFirmwareList();
            } catch (error) {
                showAlert(`Upload failed: ${error.message}`, 'error');
            }
        });

        // Load firmware list
        async function loadFirmwareList() {
            try {
                const response = await fetch(`${API_BASE}/api/firmware`);
                if (!response.ok) throw new Error('Failed to load firmware list');

                const firmwareList = await response.json();
                const container = document.getElementById('firmwareList');

                if (firmwareList.length === 0) {
                    container.innerHTML = '<p>No firmware versions available.</p>';
                    return;
                }

                container.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Version</th>
                                <th>Channel</th>
                                <th>Size</th>
                                <th>Downloads</th>
                                <th>Success Rate</th>
                                <th>Released</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${firmwareList.map(fw => `
                                <tr>
                                    <td>${fw.version} ${fw.mandatory ? '<span class="badge badge-danger">Mandatory</span>' : ''}</td>
                                    <td><span class="badge badge-info">${fw.channel}</span></td>
                                    <td>${formatBytes(fw.file_size)}</td>
                                    <td>${fw.download_count}</td>
                                    <td>${fw.success_count}/${fw.failure_count}</td>
                                    <td>${new Date(fw.released_at).toLocaleString()}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                showAlert(`Failed to load firmware list: ${error.message}`, 'error');
            }
        }

        // Load firmware for rollout dropdown
        async function loadFirmwareForRollout() {
            try {
                const response = await fetch(`${API_BASE}/api/firmware`);
                const firmwareList = await response.json();
                const select = document.getElementById('rolloutFirmware');
                select.innerHTML = '<option value="">Select firmware...</option>' +
                    firmwareList.map(fw => `<option value="${fw.version}">${fw.version} (${fw.channel})</option>`).join('');
            } catch (error) {
                console.error('Failed to load firmware for rollout:', error);
            }
        }

        // Toggle rollout fields
        function toggleRolloutFields() {
            const type = document.getElementById('rolloutType').value;
            document.getElementById('rolloutPercentageGroup').classList.toggle('hidden', type !== 'gradual');
            document.getElementById('scheduledForGroup').classList.toggle('hidden', type !== 'scheduled');
        }

        // Toggle target fields
        function toggleTargetFields() {
            const type = document.getElementById('targetType').value;
            document.getElementById('targetChannelGroup').classList.toggle('hidden', type !== 'channel');
            document.getElementById('targetUserGroup').classList.toggle('hidden', type !== 'user');
            document.getElementById('targetPrinterGroup').classList.toggle('hidden', type !== 'printer');
        }

        // Create rollout
        document.getElementById('rolloutForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const targetType = document.getElementById('targetType').value;
            let target = { all: targetType === 'all' };

            if (targetType === 'channel') {
                const channels = Array.from(document.getElementById('targetChannels').selectedOptions).map(o => o.value);
                target = { ...target, channels };
            }

            const payload = {
                firmware_version: document.getElementById('rolloutFirmware').value,
                target: target,
                rollout_type: document.getElementById('rolloutType').value,
                rollout_percentage: parseInt(document.getElementById('rolloutPercentage').value) || 100,
                scheduled_for: document.getElementById('scheduledFor').value || null
            };

            try {
                const response = await fetch(`${API_BASE}/api/rollouts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(authToken ? { 'Authorization': `Bearer ${authToken}` } : {})
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to create rollout');
                }

                showAlert('Rollout created successfully!');
                document.getElementById('rolloutForm').reset();
                loadRollouts();
            } catch (error) {
                showAlert(`Failed to create rollout: ${error.message}`, 'error');
            }
        });

        // Load rollouts
        async function loadRollouts() {
            try {
                const response = await fetch(`${API_BASE}/api/rollouts`);
                if (!response.ok) throw new Error('Failed to load rollouts');

                const data = await response.json();
                const container = document.getElementById('rolloutList');

                if (data.rollouts.length === 0) {
                    container.innerHTML = '<p>No rollouts found.</p>';
                    return;
                }

                container.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Firmware</th>
                                <th>Status</th>
                                <th>Type</th>
                                <th>Progress</th>
                                <th>Targets</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.rollouts.map(rollout => `
                                <tr>
                                    <td>${rollout.id}</td>
                                    <td>${rollout.firmware_version} (${rollout.channel})</td>
                                    <td><span class="badge badge-${getStatusBadgeClass(rollout.status)}">${rollout.status}</span></td>
                                    <td>${rollout.rollout_type}${rollout.rollout_type === 'gradual' ? ` (${rollout.rollout_percentage}%)` : ''}</td>
                                    <td>
                                        ‚úÖ ${rollout.completed_count} |
                                        ‚ùå ${rollout.failed_count} |
                                        ‚è≥ ${rollout.pending_count}
                                    </td>
                                    <td>${rollout.total_targets}</td>
                                    <td>
                                        ${rollout.status === 'active' ? `<button class="danger" onclick="pauseRollout(${rollout.id})">Pause</button>` : ''}
                                        ${rollout.status === 'paused' ? `<button onclick="resumeRollout(${rollout.id})">Resume</button>` : ''}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            } catch (error) {
                showAlert(`Failed to load rollouts: ${error.message}`, 'error');
            }
        }

        function getStatusBadgeClass(status) {
            const classes = {
                'active': 'success',
                'paused': 'warning',
                'completed': 'success',
                'cancelled': 'danger',
                'pending': 'info'
            };
            return classes[status] || 'info';
        }

        async function pauseRollout(id) {
            await updateRollout(id, { status: 'paused' });
        }

        async function resumeRollout(id) {
            await updateRollout(id, { status: 'active' });
        }

        async function updateRollout(id, payload) {
            try {
                const response = await fetch(`${API_BASE}/api/rollouts/${id}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(authToken ? { 'Authorization': `Bearer ${authToken}` } : {})
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error('Failed to update rollout');
                showAlert('Rollout updated successfully!');
                loadRollouts();
            } catch (error) {
                showAlert(`Failed to update rollout: ${error.message}`, 'error');
            }
        }

        // Load printers
        async function loadPrinters() {
            const status = document.getElementById('printerStatus').value;
            const channel = document.getElementById('printerChannel').value;
            const firmwareVersion = document.getElementById('printerFirmwareVersion').value;

            const params = new URLSearchParams();
            if (status) params.append('online', status);
            if (channel) params.append('channel', channel);
            if (firmwareVersion) params.append('firmware_version', firmwareVersion);

            try {
                const response = await fetch(`${API_BASE}/api/printers?${params}`);
                if (!response.ok) throw new Error('Failed to load printers');

                const data = await response.json();
                const container = document.getElementById('printerList');

                if (data.printers.length === 0) {
                    container.innerHTML = '<p>No printers found.</p>';
                    return;
                }

                container.innerHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Name</th>
                                <th>UUID</th>
                                <th>Firmware</th>
                                <th>Channel</th>
                                <th>Auto Update</th>
                                <th>Last Connected</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.printers.map(printer => `
                                <tr>
                                    <td>
                                        <span class="status-indicator status-${printer.online ? 'online' : 'offline'}"></span>
                                        ${printer.online ? 'Online' : 'Offline'}
                                    </td>
                                    <td>${printer.name}</td>
                                    <td><code>${printer.uuid}</code></td>
                                    <td>${printer.firmware_version}</td>
                                    <td>${printer.update_channel}</td>
                                    <td>${printer.auto_update ? '‚úÖ' : '‚ùå'}</td>
                                    <td>${printer.last_connected ? new Date(printer.last_connected).toLocaleString() : 'Never'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <p><strong>Total:</strong> ${data.total} printers</p>
                `;
            } catch (error) {
                showAlert(`Failed to load printers: ${error.message}`, 'error');
            }
        }

        // WebSocket functions
        function connectWebSocket() {
            const url = document.getElementById('wsUrl').value;
            ws = new WebSocket(url);

            ws.onopen = () => {
                showWsStatus('Connected to WebSocket', 'success');
                logMessage('‚úÖ WebSocket connected');
            };

            ws.onmessage = (event) => {
                logMessage(`üì® Received: ${event.data}`);
            };

            ws.onclose = () => {
                showWsStatus('Disconnected from WebSocket', 'error');
                logMessage('‚ùå WebSocket disconnected');
            };

            ws.onerror = (error) => {
                showWsStatus('WebSocket error', 'error');
                logMessage(`‚ùå WebSocket error: ${error}`);
            };
        }

        function disconnectWebSocket() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function showWsStatus(message, type) {
            const statusDiv = document.getElementById('wsStatus');
            statusDiv.textContent = message;
            statusDiv.className = `alert alert-${type}`;
            statusDiv.style.display = 'block';
        }

        function logMessage(message) {
            const log = document.getElementById('messageLog');
            const timestamp = new Date().toLocaleTimeString();
            log.textContent = `[${timestamp}] ${message}\n` + log.textContent;
        }

        function clearMessageLog() {
            document.getElementById('messageLog').textContent = 'No messages yet...';
        }

        // Send printer subscription
        document.getElementById('subscriptionForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const message = {
                printer_name: document.getElementById('printerName').value,
                api_key: document.getElementById('apiKey').value,
                firmware_version: document.getElementById('currentFirmwareVersion').value,
                auto_update: document.getElementById('autoUpdate').value === 'true',
                update_channel: document.getElementById('updateChannel').value
            };
            sendWebSocketMessage(message);
        });

        // Send firmware progress
        document.getElementById('progressForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const message = {
                kind: 'firmware_progress',
                percent: parseInt(document.getElementById('progressPercent').value),
                status: document.getElementById('progressStatus').value
            };
            sendWebSocketMessage(message);
        });

        // Send firmware complete
        document.getElementById('completeForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const message = {
                kind: 'firmware_complete',
                version: document.getElementById('completedVersion').value
            };
            sendWebSocketMessage(message);
        });

        function sendWebSocketMessage(message) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(message));
                logMessage(`üì§ Sent: ${JSON.stringify(message, null, 2)}`);
            } else {
                showAlert('WebSocket not connected', 'error');
            }
        }

        // Utility functions
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Initialize
        loadFirmwareList();
    </script>
</body>
</html>
